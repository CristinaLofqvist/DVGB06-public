<!--*********************************************************************
 * Bloggsida med JavaScript
 * Written by Cristina Löfqvist/ Karlstad University in June-2020.
 *********************************************************************-->

<!DOCTYPE html>
<html lang="sv">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>

    <script>
        /*Show bloggposts*/
        function getPosts() {
            var xhttp = new XMLHttpRequest();
            xhttp.open("GET", "/blogg/posts/get", true);
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    var response = this.responseText;
                    var posts = JSON.parse(response);
                    console.log(posts);
                    var posts = document.getElementById("posts");

                    for (var i = 0; i < posts.length; i++) {
                        console.log(posts[i]);
                        var userName = posts[i].userName;
                        var elemTableRow = document.createElement("TR");
                        var elemId = document.createElement("TD");
                        elemId.innerHTML = posts[i]._id;
                        var elemPostId = document.createElement("TD");
                        elemPostId.innerHTML = posts[i].postId;
                        var elemCourseName = document.createElement("TD");
                        elemUserName.innerHTML = posts[i].userName;
                        var elemPeriod = document.createElement("TD");
                        elemPeriod.innerHTML = posts[i].postDate;
                        var elemBin = document.createElement("TD");
                        var binImg = document.createElement("IMG");
                        binImg.src = "./Assets/icons8-delete-trash-50.png";

                        binImg.onclick = deletePost;

                        elemBin.appendChild(binImg);



                        elemTableRow.appendChild(elemId);
                        elemTableRow.appendChild(elemCourseId);
                        elemTableRow.appendChild(elemCourseName);
                        elemTableRow.appendChild(elemPeriod);
                        elemTableRow.appendChild(elemBin);

                        courseTable.appendChild(elemTableRow);

                    }

                }
            };
            xhttp.send();
        }

        function deletePost(e) {
            var i = e.target.parentNode.parentNode.rowIndex;
            id = document.getElementById("posts").rows[i].cells[0].innerHTML
            console.log("deleting: " + id);
            var xhttp = new XMLHttpRequest();
            xhttp.open("DELETE", "/blogg/posts/delete/" + id, true);
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    document.getElementById("posts").deleteRow(i);
                }
            };
            xhttp.send();
        }
        /*Tar värdet från input elementet i form*/
        function addPost() {
            //let post_id = document.getElementById("postid").value;
            let user_name = document.getElementById("username").value;
            let title = "test title"
            let content = "test content"
            //let date = document.getElementById("date").value;
            var xhttp = new XMLHttpRequest();

            let json = JSON.stringify({
                //postId: post_id,
                userName: user_name,
                title: title,
                content: content
                //date: date
            });
            xhttp.open("POST", '/blogg/posts/add', true)
            xhttp.setRequestHeader('Content-type', 'application/json; charset=utf-8');
            xhttp.send(json);

            location.reload();
        }

    </script>
</head>

<body onload="getPosts()">

    <section id="main_content">
        <h1>Välkommen till vår blogg<h1>

                <h3>Skriv gärna ett blogginlägg</h3>
                <form id="messageForm" method="post">
                    <label>Namn</label>
                    <input type="text" name="author" class="inputArea" placeholder="Ditt namn...">
                    <br>
                    <label>blogginlägg</label>
                    <textarea name="message" id='bloggPost' placeholder="Ditt blogginlägg..."></textarea>
                    <br>
                    <p>
                        <input type="submit" value="Nytt inlägg" class="newPost" class="inputArea">
                    </p>
                </form>

                <script>
            //CKEDITOR.replace('postMessage');
                </script>

                <a href="blogg.html">Visa data</a>

                <h3 id="font2">Blogginlägg:</h3>
    </section>
</body>

</html>